-- -*- mode: lua; encoding: windows-1251 -*-
---------------------------------------------------------------------
-- Привет от Сяка 
---------------------------------------------------------------------

local math_random = math.random
local math_atan2 = math.atan2
local math_sin = math.sin
local math_cos = math.cos
local string_find = string.find
local string_format = string.format
local string_gsub = string.gsub

function add_new_escape_100()
add_new_lc(9100,4426,"На Кордон","info_way100a",3)
end
function add_new_agroprom_101()
add_new_lc(9101,2826,"На Агропром","info_way101a",4)
end
function add_new_yantar_102()
add_new_lc(9102,4427,"На Янтарь","info_way102a",1)
end
function add_new_agroprom_103()
add_new_lc(9103,8355,"На Агропром","info_way103a",3)
end
function add_new_mil_104()
add_new_lc(9104,6941,"На Армейские Склады","info_way104a",4)
end
function add_new_rostok_105()
add_new_lc(9105,7482,"На Дикую Территорию","info_way105a",4)
end
function add_new_radar_106()
add_new_lc(9106,8356,"На Радар","info_way106a",1)
end
function add_new_darkvalley_107()
add_new_lc(9107,9109,"В Тёмную Долину","info_way107a",2)
end
function add_new_yantar_108()
add_new_lc(9108,9108,"На Янтарь","info_way108a",3)
end
function add_new_radar_109()
add_new_lc(9109,5157,"На Радар","info_way109a",2)
end
function add_new_mil_110()
	add_new_lc(9110,5158,"На Армейские Склады","info_way110a",1)
	local obj = alife():story_object(9110)
	if obj then
		alife():teleport_object("", vector():set(-49.27893447876,-1.8120930194855,-24.721027374268),116037,1019, obj.id)
	end
end
function add_new_darkvalley_111()
add_new_lc(9111,7483,"В Тёмную Долину","info_way111a",3)
end
function add_new_military_01()
add_new_lc(1008,9390,"На Армейские Склады","info_way112a",3)
end
function add_new_military()
add_new_lc(592,6851,"На Армейские Склады","info_way113a",1)
end
--' болото-старая деревня
function add_new_rostok()
add_new_lc(97101,13109,"В Старую Деревню","info_way114a",1)
end
function add_new_to_garbage()
add_new_lc(11504,13822,"На Свалку","info_way_arhara_peshera_cvalka",5)
end
function add_new_to_agro()
add_new_lc(11505,13823,"На Агропром","info_way_arhara_peshera_agro",5)
end
--' открывается сразу 2 перехода
function add_new_to_peshera1()
add_new_lc(11502,3793,"В Пещеру","info_way_arhara_cvalka_peshera",4)
add_new_lc(11503,4395,"В Пещеру","info_way_arhara_agro_peshera",2)
end
--' кордон-болота
function add_new_to_peshera2()
add_new_lc(14002,2823,"На Болота","info_way_arhara_kordon_boloto",4)
end
function add_new_to_les()
add_new_lc(97071,5150,"В Забытый Лес","info_way_arhara_td_les",4)
end
function add_new_to_peshera3()
add_new_lc(97081,522,"В Пещеру","info_way_arhara_labirint_peshera",5)
end
function add_new_to_labirint()
add_new_lc(97021,13686,"В Лабиринт","info_way_arhara_peshera_labirint",5)
end
function add_new_labirint_to_yantar()
add_new_lc(11512,335,"На Янтарь","info_way_arhara_labirint_yantar",5)
end
function add_new_labirint_to_earth()
add_new_lc(11511,314,"На Неразведанную Землю","info_way_arhara_labirint_earth",5)
end
function add_new_yantar_to_labirint()
add_new_lc(11515,8352,"В Лабиринт","info_way_arhara_yantar_labirint",3)
end
function add_new_atp_to_pripyat()
add_new_lc(97041,94,"В Центральную Припять","info_way_arhara_atp_pripyat",1)
end
function add_new_atp_to_military()
add_new_lc(97091,132,"На Армейские Склады","info_way_arhara_atp_military",2)
end
function add_new_atp_to_kordon()
add_new_lc(97092,133,"На Кордон","info_way_arhara_atp_kordon",3)
end
function add_new_atp_to_svalka()
add_new_lc(97093,183,"На Свалку","info_way_arhara_atp_svalka",2)
end
--' Припять-Старая Деревня
function add_new_military_to_earth()
add_new_lc(97100,10243,"В Старую Деревню","info_way_arhara_pripyt_village",4)
end
--' открывается сразу 2 перехода
function add_new_td_to_earth()
add_new_lc(11513,5151,"На Неразведанную Землю","info_way_arhara_td_earth",4)
add_new_lc(11514,7478,"На Неразведанную Землю","info_way_arhara_military_earth",3)
end
function add_new_svalka_to_earth()
add_new_lc(12506,3792,"На Неразведанную Землю","info_way_arhara_svalka_earth",2)
end
function add_new_earth_to_labirint()
add_new_lc(11510,774,"В Лабиринт","info_way_arhara_earth_labirint",4)
end
--' открывается сразу 2 перехода
function add_new_radar_to_warlab()
add_new_lc(97094,9085,"В Варлаб","info_way_arhara_radar_warlab",4)
add_new_lc(97095,14961,"В Лабораторию Х-16","info_way_arhara_warlab_brainlab",5)
end
--' х18-Варлаб
function add_new_warlab_to_brainlab()
add_new_lc(97098,5867,"В Варлаб","info_way_arhara_x18_warlab",5)
end
function add_new_warlab_to_skladu()
add_new_lc(97097,14827,"На Армейские Склады","info_way_arhara_warlab_skladu",5)
end
function add_new_radar_na_red_forest()
add_new_lc(14091,9080,"В Красный лес","info_way_arhara_radar_forest",4)
end
function add_new_chaes2_to_atp()
add_new_lc(97099,11300,"На АТП","info_way_arhara_chaes2_atp",2)
end
function add_new_village_to_limansk()
add_new_lc(11529,12993,"В Лиманск","info_way_arhara_village_limansk",4)
end
function add_new_village_to_hospital()
add_new_lc(11531,12994,"В Госпиталь","info_way_arhara_village_hospital",1)
end
function add_new_chaes_to_generator()
add_new_lc(97103,10857,"На Генераторы","info_way_arhara_chaes_generator",3)
end
function add_new_hospital_to_agroprom()
add_new_lc(97104,2219,"На Агропром","info_way_arhara_hospital_agroprom",3)
end
function add_new_agroprom_to_marsh1()
add_new_lc(97105,4344,"На Болота","info_way_arhara_agroprom_marsh1",3)
end
function add_new_bar_to_atp()
add_new_lc(97001,6453,"На АТП","info_way_arhara_bar_atp",4)
end
function add_new_gener_to_pripyat()
add_new_lc(97106,1830,"В Центральную Припять","info_way_arhara_gener_pripyat",3)
end
function add_new_chaes2_to_chaes()
	add_new_lc(97102,11299,"На ЧАЭС-1","info_way_arhara_chaes2_chaes",3)
	add_new_lc(97115, 0, "На ЧАЭС-2", "perehod_chaes2_na_chaes", 1)
end
function add_new_gener_to_hospital()
add_new_lc(11521,1558,"В Госпиталь","info_way_arhara_gener_hospital",1)
end
function add_new_warlab_to_generators()
add_new_lc(97096,14782,"На Генераторы","info_way_arhara_warlab_generators",5)
end
function add_new_limansk_to_generators()
add_new_lc(97107,12451,"На Генераторы","info_way_arhara_limansk_generators",2)
end
function add_new_forest_to_warlab()
add_new_lc(97108,14320,"В Варлаб","info_way_arhara_forest_warlab",1)
end
--' переходы МГ
function add_new_dcity()
add_new_lc(97109,1287,"В Лиманск","info_way_arhara_dcity_limansk",1)
add_new_lc(97110,1288,"На АТП","info_way_arhara_dead_city_atp",2)
add_new_lc(97111,1289,"На Дикую Территорию","info_way_arhara_dcity_rostok",3)
add_new_lc(97112,302,"В Мёртвый Город","info_way_arhara_atp_dead_city",4)
end
function add_new_dcity_to_zaton()
add_new_lc(97113,1446,"На Затон","info_way_arhara_dcity_zaton",2)
end
function add_new_lima_to_dead_city()
	add_new_lc(97114,12395,"В Мёртвый Город","info_way_arhara_lima_dcity",2)
	local obj = alife():story_object(97114)
	if obj then
		alife():teleport_object("", vector():set(-52.046363, -10.754915, -184.263061), 4128, 2993, obj.id)
	end
end

-- Убрана привязка к номеру секции - переделано на spawn_story_id. 
-- levchn больше не нужен. 
-- При добавлении сюда новых переходов прописывать им в алспавне spawn_story_id, равный story_id.
function add_new_lc(levch,levchn,levchm,info,dir)
	local sim = alife()
	local objt = sim:story_object(levch)
	if objt then
		log("~ level changer with story_id [%d] already exist! Respawn...", levch)
		sim:release(objt, true)
	end
	local obj = sim:create(sim:spawn_id(levch))
	if obj then
		level.map_add_object_spot_ser(obj.id, "level_changer"..tostring(dir),levchm)
		if not has_alife_info(info) then
			db.actor:give_info_portion(info)
		end
		show_lc_info(obj)
	end
end
function show_lc_info(obj)
	if obj == nil then
		log("! sak.show_lc_info: ERROR :: obj is nil!")
		return
	end
	
	local data = netpk:get(obj, netpk.fState)
	local dest_lvl = game.translate_string(string.lower(data.dest_level_name))
	local prev_lvl = game.translate_string(alife():level_name(game_graph():vertex(data.game_vertex_id):level_id()))
	info_received(prev_lvl..' >> '..dest_lvl)
end
function add_new_military_false()
local obj = alife():story_object(5212)
level.map_add_object_spot(obj.id, "level_changer1","На ЧАЭС")
  db.actor:give_info_portion("info_way_false")
  info_received("Армейские Склады >> ЧАЭС")
end

function out_excess_lc()
	local out_lchangers = {
		[9100] = "info_way100a",
		[9101] = "info_way101a",
		[9102] = "info_way102a",
		[9103] = "info_way103a",
		[9104] = "info_way104a",
		[9105] = "info_way105a",
		[9106] = "info_way106a",
		[9107] = "info_way107a",
		[9108] = "info_way108a",
		[9109] = "info_way109a",
		[9110] = "info_way110a",
		[9111] = "info_way111a",
		[1008] = "info_way112a",
		[592] = "info_way113a",
		[97101] = "info_way114a",
		[11504] = "info_way_arhara_peshera_cvalka",
		[11505] = "info_way_arhara_peshera_agro",
		[11502] = "info_way_arhara_cvalka_peshera",
		[11503] = "info_way_arhara_agro_peshera",
		[97071] = "info_way_arhara_td_les",
		[97081] = "info_way_arhara_labirint_peshera",
		[97021] = "info_way_arhara_peshera_labirint",
		[11512] = "info_way_arhara_labirint_yantar",
		[11515] = "info_way_arhara_yantar_labirint",
		[11511] = "info_way_arhara_labirint_earth",
		[97041] = "info_way_arhara_atp_pripyat",
		[97091] = "info_way_arhara_atp_military",
		[97092] = "info_way_arhara_atp_kordon",
		[97093] = "info_way_arhara_atp_svalka",
		[97100] = "info_way_arhara_pripyt_village", 
		[11514] = "info_way_arhara_military_earth",
		[11513] = "info_way_arhara_td_earth",
		[12506] = "info_way_arhara_svalka_earth",
		[11510] = "info_way_arhara_earth_labirint",
		[97094] = "info_way_arhara_radar_warlab",
		[97095] = "info_way_arhara_warlab_brainlab",
		[97097] = "info_way_arhara_warlab_skladu",
		[97098] = "info_way_arhara_x18_warlab",
		[14002] = "info_way_arhara_kordon_boloto",
		[14091] = "info_way_arhara_radar_forest",
		[97099] = "info_way_arhara_chaes2_atp",
		[11529] = "info_way_arhara_village_limansk",
		[11531] = "info_way_arhara_village_hospital",
		[97103] = "info_way_arhara_chaes_generator",
		[97104] = "info_way_arhara_hospital_agroprom",
		[97105] = "info_way_arhara_agroprom_marsh1",
		[97001] = "info_way_arhara_bar_atp",
		[97106] = "info_way_arhara_gener_pripyat",
		[97102] = "info_way_arhara_chaes2_chaes",
		[11521] = "info_way_arhara_gener_hospital",
		[97096] = "info_way_arhara_warlab_generators",
		[97107] = "info_way_arhara_limansk_generators",
		[97108] = "info_way_arhara_forest_warlab",
		[97109] = "info_way_arhara_dcity_limansk",
		[97110] = "info_way_arhara_dead_city_atp",
		[97111] = "info_way_arhara_dcity_rostok",
		[97112] = "info_way_arhara_atp_dead_city",
		[97113] = "info_way_arhara_dcity_zaton",
		[97114] = "info_way_arhara_lima_dcity",
		[97115] = "perehod_chaes2_na_chaes"
	}
	local sim = alife()
	local lc
	for sid, info in pairs(out_lchangers) do
		if not has_alife_info(info) then
			lc = sim:story_object(sid)
			if lc then sim:release(lc) end
	--		log1("out_lc: "..info)
		end
	end
end

function out_new_lc(levch,info)
  if not db.actor:has_info(info) then
    local objt = alife():story_object(levch)
    if objt then
      alife():release(objt)
    end
  end
end
function add_new_item_in(item,sidlh)
local nps = sidlh.id
amk.spawn_item_in_inv(item,nps) 
end

function add_new_lcitem()
	amk.spawn_item("sak_document",vector():set(350,-51.74,-24.45),2031,93051,true) -- документ под трупом ученого в рж лесу
	amk.spawn_item("rad_document6",vector():set(621.95,-42.64,187.38),1910,224619,true) -- дело в кунге у монолитовцув
	amk.spawn_item("amk_zapiska",vector():set(-132.93,11.04,-203.2),629,105467,true) --записка на третьем этаже Агропрома
	amk.spawn_item("sak_document2",vector():set(-80,-1.30,153),163,187916,true) -- документ  под жд насыпью Кордона
	amk.spawn_item("garbage_pda",vector():set(-226,-7.37,-132.36),252,208345,true) -- ПДА в лагере бандитов на свалке
	amk.spawn_item("rad_document6",vector():set(-28.4,-0.26,-173.55),676,211656,true) -- дело в вагончике Агропрома
	amk.spawn_item("rad_pda",vector():set(530.7,-49.41,-241.61),2061,180657,true) -- ПДА в вагончике на Радаре
	amk.spawn_item("rad_document6",vector():set(-139.6,-25.03,-355.6),19,116593,true) -- дело на кордоне
	amk.spawn_item("sak_book4",vector():set(-3.77,-4.25,191.19),2195,97948,true) --книга доктора
	amk.spawn_item("playboy3",vector():set(-212.99,-22.51,-126.06),59,40605,true) 
	amk.spawn_item("playboy2",vector():set(112.87,-1.94,1.6),117,413895,true)
	amk.spawn_item("playboy1",vector():set(138.57,-3.5,22.0),1237,37466,true)
	amk.spawn_item("playboy4",vector():set(-156.23,1.44,-162.05),669,82783,true)
	amk.spawn_item("playboy5",vector():set(-19.52,-3.22,-19.91),1593,287481,true)
	amk.spawn_item("playboy6",vector():set(-52.11,-10.52,35.31),1608,257284,true)
	amk.spawn_item("playboy7",vector():set(41.4,5.45,-84.15),1100,226116,true)
	amk.spawn_item("playboy8",vector():set(-135.57,1.29,-523.72),832,22097,true)
	amk.spawn_item("playboy9",vector():set(-6.19,-4.21,201.42),2195,94368,true)
	amk.spawn_item("playboy10",vector():set(306.45,-38.06,-23.05),1930,69058,true)
	amk.spawn_item("playboy11",vector():set(30.92,-2.46,-41.34),1997,20510,true)
	amk.spawn_item("playboy12",vector():set(139.89819335938,-6.5692377090454,-72.478149414063),2830,577165,true)
	amk.spawn_item("playboy13",vector():set(292.20834350586,13.639252662659,-155.84591674805),3531,325954,true)
--	amk.spawn_item("m_inventory_seif",vector():set(306.47,-39.39,-26.22),1930,69058)
	for a=1000,20000,1 do
		local obj=alife():object(a)
		if obj and ( (string_find(obj:name(),"af_") and not string_find(obj:name(),"esc_af_")  and not string_find(obj:name(),"pri_af_" ) and not string_find(obj:name(),"af_dumm")) ) then	-- or string_find(obj:name(),"esc_wpn")) then
			alife():release(obj,true)
		end
	end
end
function add_ak47()
amk.spawn_item("wpn_ak47",vector():set(108.5,7.74,-9.07),987,304788)
end
function add_doktor_book()
amk.spawn_item("sak_book4",vector():set(-3.49,-4.26,191.34),2195,96166,true)
end
function add_notebook()
amk.spawn_item("notebook",vector():set(23.87,-5.65,-18.38),1140,6287,true) 
end
-- Akill begin Изменены к-ты спавна дипломата + монстры
function add_diplomat()
amk.spawn_item("diplomat",vector():set(-100.60708618164,22.614040374756,-24.21527671814),1529,505,true)
akill.x16_mutant_spawn()
end
-- Akill end
function add_computer()
amk.spawn_item("computer",vector():set(-114.96,-2.23,8.18),2248,8511,true) 
end
function add_new_103item()
amk.spawn_item("quest_case_06",vector():set(-196.5,2.48,92.88),678,40284,true) --кейс в кунге дезертира
end
function add_sak_plan()
amk.spawn_item("sak_plan",vector():set(-213.13,2.96,92.58),535,22245,true) -- мешок плана в кунге дезертира 
end
function add_krot_pda()
amk.spawn_item("agroprom_pda",vector():set(254.866424,-0.201872,79.064804),498,428654,true) --ПДА в ЖД тоннеле Агропрома
end
function add_und_pda()
amk.spawn_item("und_pda",vector():set(-45.12,-4.01,-30.08),718,4466,true) --ПДА в подземелье Агропрома
end
function add_seif()
amk.spawn_item("inventory_sakbox_03",vector():set(15.52,-12.43,8.59),1156,5132,true) --Сейф в подземелье X-18
end
function give_seif(obj)
amk.remove_item_from_inventory_by_name(obj,db.actor)
amk.spawn_item("m_inventory_seif",vector():set(34.37,-3.37,-37.29),1997,21736,true)  --передача сейфа
end
-- Akill begin Изменены к-ты спавна декодера + монстры
function add_decoder()
amk.spawn_item("decoder1",vector():set(-60.656967163086,19.434055328369,-16.232734680176),1530,1661,true) --декодер в  X-16 возле главного пульта
akill.x16_mutant_spawn()
end
-- Akill end
function add_gauss()
amk.spawn_item("wpn_gungauss",vector():set(-126.11,0.91,-533.55),836,31356,true) --Гаусс-пистолет  в ТД
end
--function add_medusa_green()
--amk.spawn_item("af_medusa_green",vector():set(260.59,-9.82,-135),404,373051) --Изумрудная медуза на свалке
--end
function add_medusa_green()
amk.spawn_item("af_medusa_green",vector():set(5.3799324035645,-0.00055783987045288,222.37449645996),2883,192846,true)
end
function add_pellicle_red()
amk.spawn_item("af_dummy_pellicle_red",vector():set(-239.99,4.85,99.93),1362,13956,true) --Изумрудная медуза на Ростке
end
--function add_vyvert_green()
--amk.spawn_item("af_vyvert_green",vector():set(115.13,4.83,-409.26),942,311330) --Изумрудный выверт в ТД
--end
function add_blood_green()
	amk.spawn_item("af_blood_green",vector():set(55.34,1.27,40.89),1511,68094,true) --Изумрудная кровь на Янтаре 
	alife():create("yan_zombied_respawn_1",vector():set(75.406539916992,0.34422329068184,23.229085922241),79415,1512)
	alife():create("yan_zombied_respawn_2",vector():set(41.926971435547,0.037857890129089,20.751808166504),60400,1445)
	alife():create("spider",vector():set(106.78483581543,-8.8652667999268,-212.50025939941),96215,1472)
	alife():create("spider",vector():set(106.78483581543,-8.8652667999268,-212.50025939941),96215,1472)
	alife():create("spider",vector():set(106.78483581543,-8.8652667999268,-212.50025939941),96215,1472)
	alife():create("spider",vector():set(106.78483581543,-8.8652667999268,-212.50025939941),96215,1472)
	alife():create("spider",vector():set(106.78483581543,-8.8652667999268,-212.50025939941),96215,1472)
	alife():create("m_poltergeist_dd",vector():set(58.236850738525,-0.84842598438263,-20.68497467041),69709,1508)
	alife():create("electro_polter",vector():set(56.451206207275,0.046565324068069,-60.764457702637),68827,1516)
	alife():create("polter_xray",vector():set(27.053871154785,0.084938794374466,-9.735237121582),52620,1507)
	alife():create("controller_flame",vector():set(90.896003723145,0.028825730085373,12.075715065002),87194,1513)
	alife():create("m_controller_act",vector():set(15.076522827148,0.030788093805313,19.65348815918),46805,1445)
	artefact_hunter.add_art_info("af_blood_green")
end
function add_battery_red()
amk.spawn_item("af_dummy_battery_red",vector():set(668.9,-45.79,-39.93),1896,227187,true) --Рубиновая батарейка на Радаре 
end
--function add_order()
--local obj = alife():story_object(9115)
--alife():create("rad_document7",obj.position, obj.m_level_vertex_id, obj.m_game_vertex_id, obj.id)
--end
function add_two_corpses()
	local obj = amk.spawn_item("yan_ecolog_respawn_2",vector():set(187.84,5.18,-360.68),938,386349)
	local tbl = {}
	tbl.story_id = 48800
	tbl.health = 0
	tbl.upd = { health = 0 }
	netpk:modify( obj,tbl )					

	alife():create("scaintist_docs",obj.position, obj.m_level_vertex_id, obj.m_game_vertex_id, obj.id)

	obj=amk.spawn_item("yan_ecolog_respawn_2",vector():set(187.66,5.03,-375.97),938,386327)
	tbl.story_id = 48801
	netpk:modify( obj,tbl )

	amk.spawn_item("inventory_sakbox_05",vector():set(176.83,8.37,-375.96),938,377568)
end
function add_scaintist_body()
	local obj=amk.spawn_item("yan_ecolog_respawn_2",vector():set(-46.53,-2.2,-98.36),2258,53082)
	local tbl = {}
	tbl.story_id = 48802
	tbl.health = 0
	tbl.upd = { health = 0 }
	netpk:modify( obj,tbl )
	alife():create("scaintist_pda",obj.position, obj.m_level_vertex_id, obj.m_game_vertex_id, obj.id)
end
function add_agroprom_box()
	for a=1000,10000,1 do
	local obj=alife():object(a)
		if (obj and obj.name and obj:name() == "agr_quest_case_02") then
		alife():release(obj, true)
		--dbglog("keis: "..a) ~5665
		end
	end	
	--amk.spawn_item("quest_case_02",vector():set(18.76,-2.23,-219.12),436,259029)
	dialogs.relocate_item_section(db.actor, "quest_case_02", "in")
end
-- Akill begin
function add_kontainer()
--	amk.spawn_item("inventory_sakbox_05",vector():set(378,-52,-179.20),2097,101537)
	alife():create("inventory_sakbox_05",vector():set(467.15960693359,-48.180206298828,-294.86013793945),155265,2063)
	alife():create("chimera_black",vector():set(486.33248901367,-48.54475402832,-236.83911132813),160400,2058)
	alife():create("zombie_beee",vector():set(544.77508544922,-50.461318969727,-251.75929260254),187962,2114)
	alife():create("zombie_blow",vector():set(545.21411132813,-57.409252166748,-226.63201904297),188356,1873)
	alife():create("zombie_hell",vector():set(568.07763671875,-60.318313598633,-221.79908752441),199631,1873)
	alife():create("bear",vector():set(514.51159667969,-50.558048248291,-283.08618164063),172856,2060)
	alife():create("chimera_weak",vector():set(478.98034667969,-54.138397216797,-254.24066162109),157244,2111)
	alife():create("controller_senator",vector():set(543.19293212891,-53.148582458496,-239.98249816895),187241,2114)
	alife():create("controller_babka",vector():set(563.63739013672,-62.943653106689,-199.03614807129),197039,1884)
end
function agroprom_wpm()
local obj = alife():story_object(9115)
alife():create("wpn_vintorez_m1",obj.position, obj.m_level_vertex_id, obj.m_game_vertex_id, obj.id)
	alife():create("zasada_tonnel_agro_2",vector():set(-120.86868286133,14.998485565186,-192.318359375),118958,642)
	alife():create("agro_elite_rpg",vector():set(-170.82591247559,5.3163747787476,-182.25466918945),66088,667)
	alife():create("zasada_tonnel_agro_1",vector():set(-121.89569091797,4.9972257614136,-198.87106323242),118189,617)
	alife():create("soldier_mines_regular",vector():set(-196.39508056641,7.3849902153015,-223.58135986328),39867,555)
	alife():create("soldier_mines_veteran",vector():set(-175.36352539063,7.3837895393372,-154.81077575684),61033,560)
	alife():create("soldier_mines_regular",vector():set(-106.75975036621,7.3841366767883,-136.29498291016),132868,696)
	alife():create("soldier_mines_veteran",vector():set(-108.10691833496,7.3828616142273,-207.12539672852),132051,552)
end
function add_books()
amk.spawn_item("sak_book1",vector():set(28.11,-12.07,38.93),1161,6530) 
amk.spawn_item("sak_book2",vector():set(-120.27,21.56,-32.65),1529,165) 
amk.spawn_item("sak_book3",vector():set(0.77,-19.45,24.89),2768,6203) 
end
function add_new_111item()
	alife():create("soldier_mines_veteran",vector():set(69.474830627441,0.55580735206604,25.300632476807),305190,671)
	alife():create("soldier_mines_regular",vector():set(63.35139465332,-0.20042996108532,-0.63388842344284),299977,462)
	alife():create("soldier_mines_veteran",vector():set(9.7593650817871,0.97461330890656,37.45044708252),250081,490)
	local obj = alife():create("dynamite",vector():set(54.160469055176,0.78570091724396,23.48705291748),292636,461)
	level.map_add_object_spot_ser(obj.id, "crlc_big", "Возможное местоположение динамита")
end
function dynamite_metka_delete()
	local obj
	for a=1,65534,1 do
	obj=alife():object(a)
	if obj and string.find(obj:name(),"dynamite") then
	level.map_remove_object_spot(obj.id,"crlc_big")
	break
	end
	end
end
function add_new_109item()
	alife():create("quest_case_05",vector():set(124.79997253418,2.2573802471161,-263.01544189453),321655,955)
end
-- Akill end
function info_received(text)
	if (not text) or type(text)~="string" then return end
	amk.send_tip(text,"Новый путь!",0,10,"nano")
	if db.actor:is_talking() then
		local task_texture, task_rect = get_texture_info("ui_iconsTotal_locations", "ui_iconsTotal_locations")
		local news_text = "%c[255,160,160,160]Новый путь!\\n%c[white]"..text
		db.actor:give_talk_message(news_text, task_texture, task_rect,"iconed_answer_item")
	end
end
--function add_resiver()
--amk.spawn_item("sak_resiver",vector():set(-185.57,-3.58,94.89),338,39411) 
--end
function add_drug()
--amk.spawn_item("dogfrend",vector():set(-6.71,0.41,247.19),258,170000) 
amk.spawn_item("dogfrend",vector():set(80.702026367188,0.60556876659393,163.72595214844),364,249786) 
end
--function add_strelok_pda()
--amk.spawn_item("strelok_pda",vector():set(42.95,61.56,-26.25),2417,6406) 
--end
function info_strelok_pda()
  amk.send_tip("","Сталкер! Остановись!",0,10,"gen_info")
end
function info_artmod()
--  amk.send_tip("","Новый артмод!",0,10,"gen_info")
end
function info_doktor()
  amk.send_tip("","Болотный доктор жив!",0,10,"gen_info")
end
function info_teleport()
  amk.send_tip("","Телепорт готов.",0,10,"gen_info")
end

function make_kill_task_failed(actor,npc,p1,p2) 
  local nid=npc:id()
  if nid==db.actor:id() then
    nid=actor:id()
  end
  local targets=task_manager.amk_kill_targets()
  for n,v in pairs(targets) do
    if v.id==nid then
      task_manager.make_task_failed(v.task_id)
    end
  end  
end

function agr_ratcatcher__id()
for a=5000,6000,1 do
		local obj=alife():object(a)
		if (obj and obj.name and obj:name() == "agr_ratcatcher") then
		--dbglog("Entered: "..obj:name().." id "..a.." sid "..obj.m_story_id) -- id~5564
		amk.save_variable("agr_ratcatcher_id", a) 
		end
	end
end

-- список неписей, которых можно воскресить живым сердцем. 
-- story_id   = story_id непися
-- _umer = true - у непися есть поршень с приставкой "_umer"
-- info  = дополнительные поршни, которые выдаются при смерти
-- script = функция, которая воскрешает непися при скриптовом спавне
-- при добавлении непися в эту таблицу в info_arhara_way нужно добавить поршень "nu"..story_id, а также в алспауне прописать spawn_story_id, равное story_id
local nepis = {
	-- Кордон
	{story_id = 4, _umer = true},		-- Шустрый
	{story_id = 5, _umer = true},		-- Лис
	{story_id = 6, _umer = true},		-- Волк
	{story_id = 7, _umer = true},		-- Толик
	{story_id = 9, _umer = true},		-- Петруха
	{story_id = 22, _umer = true, info = {"esc_fanat_die"}},		-- Фанат
	{story_id = 32, _umer = true},		-- Кузнецов
	{story_id = 92, _umer = true},		-- Проводник
	-- Пещера
	{story_id = 19801},					-- Хабарыч
	{story_id = 19802},					-- Стаханов
	{story_id = 19803},					-- Фима Уголь
	-- Свалка
	{story_id = 107, _umer = true, info = {"gar_hellcar_death", "sar2_death_14"}},	-- Бес
	{story_id = 115, _umer = true},		-- Прапор
	{story_id = 9509, info = {"death_artem"}},		-- Кулинар
	{story_id = 9510, info = {"death_voron"}},		-- Ворон
	{story_id = 100, info = {"garbage_meetstalker_die", "sar2_death_10"}},	-- Серый
	{story_id = 104, _umer = true, info = {"gar_dm_novice_dead"}},			-- Юрик
	-- Агропром
	{story_id = 302, _umer = true, info = {"agr_krot_dead", "sar2_death_19"}},	-- Крот
	{story_id = 370, _umer = true, info = {"sar2_death_11"}},		-- Дезертир
	{story_id = 9506, info = {"sherstuk_enemy"}},				-- Шерстюк
	{story_id = 14006, info = {"chuk_dead"}},					-- Чук
	{story_id = 14007, info = {"gek_dead"}},					-- Гек
	-- Забытый Лес
	{story_id = 30117,  script = "buusty_dialog.prygorshnya_resurrect"},				-- Пригоршня
	{story_id = 30118, trup = true, script = "buusty_dialog.himik_resurrect"},	-- Химик труп
	{story_id = 30124, script = "buusty_dialog.himik_resurrect"},					-- Химик живой
	-- Темная Долина
	{story_id = 400, _umer = true},		-- Макс Любер
	{story_id = 401, info = {"val_sacrifice_victim_dead"}},	-- пленный долговец в сценке у ямы
	{story_id = 402, info = {"val_prisoner_dead"}},		-- пленный долговец в камере в подвале
	{story_id = 406, _umer = true},		-- Пуля
	{story_id = 422, info = {"val_sos_dead", "val_sos_got_medkit"}},	-- Мессер
	{story_id = 425, info = {"val_borov_dead"}},	-- Боров
	{story_id = 9507},					-- Жила
	-- Бар
	{story_id = 505, _umer = true, info = {"sar2_death_41"}},		-- Иванцов
	{story_id = 506, _umer = true, info = {"sar2_death_42"}},		-- Петренко
	{story_id = 507, _umer = true, info = {"sar2_death_43", "bar_voronin_dead"}},	-- Воронин
	{story_id = 516, _umer = true},		-- Пличко
	{story_id = 19805},					-- Гарик
	{story_id = 515},					-- Осведомитель
	{story_id = 504},					-- Охотник
	{story_id = 510},					-- Бром (которому ружье принести нужно)
	{story_id = 607},					-- Лысый
	{story_id = 519, _umer = true},		-- Барин
	{story_id = 571},					-- Арни
	{story_id = 9619},					-- Фримен
	{story_id = 518},					-- Киценко (командир южного блокпоста)
	{story_id = 9613},					-- Захар
	-- Дикая Территория
	{story_id = 503, info = {"bar_heli_scene_professor_die", "sar2_death_13"}},	-- Круглов на ДТ
	-- Янтарь
	{story_id = 900, info = {"yan_scientist_die"}},	-- Круглов на Янтаре
	{story_id = 19028, info = {"chernomor_umer"}},	-- Черномор вылеченный
	-- Армейские Склады
	{story_id = 702, _umer = true},		-- Макс
	{story_id = 707, _umer = true},		-- Лукаш
	{story_id = 728, _umer = true},		-- Повар
	{story_id = 734, _umer = true},		-- Скряга
--	{story_id = 19804},					-- Витамин
	{story_id = 777888},				-- Шуруп
	{story_id = 19810},					-- Альфа 2012 (охранник на входе на базу Свободы)
	{story_id = 724},					-- Кэп (командир Барьера)
	-- ЧАЭС2
	{story_id = 9969, _umer = true, script = "kostya_dialog.tm_brother_2chaes_spawn"},	-- Брат Тени Монолита
	-- Болота
	{story_id = 19811, info = {"dyak_dead"}},		-- Дьяк
	{story_id = 14003, info = {"kalmyak_dead"}},	-- Калмык
	-- ВП
	{story_id = 21005, info = {"akill_npc_dead"}, script = "akill.akill_npc_spawn"},	-- Акилл
	-- Варлаб
	{story_id = 19809},					-- Сольвадор
	{story_id = 22005, _umer = true}, 	-- Лентяй
	-- НЗ
	{story_id = 9973},					-- Старик
	{story_id = 9974},					-- Отшельник
	-- Генераторы
	{story_id = 19806, _umer = true},	-- Земляк
	{story_id = 19807}					-- Андерсен
}
function deadman_to_life(art)
	local obj
	local sim = alife()
	for a=1,#nepis do 
		obj = sim:story_object(nepis[a].story_id)
		if obj and (not obj:alive()) and obj.position:distance_to(db.actor:position()) < 2 then

			-- снимаем нужные поршни
			if not nepis[a].trup then
				db.actor:disable_info_portion("nu"..tostring(nepis[a].story_id))
			end
			if nepis[a]._umer then
				db.actor:disable_info_portion(obj:name().."_umer")
			end
			if nepis[a].info then
				for b=1,#nepis[a].info do 
					db.actor:disable_info_portion(nepis[a].info[b])
				end
			end

			--  воскрешаем
			level.start_stop_menu(level.main_input_receiver(), true)
			amk_mod.af_flash(art)
			amk.send_tip("%c[255,0,255,0]Обнаружен новый сталкер: "..naxac_netpk.get_character_name(obj)..". Добавлен в базу данных сети.%c[default]", "ЛОКАЛЬНАЯ СЕТЬ", 0, 15, "questman_death")
			local pos, lv, gv = obj.position, obj.m_level_vertex_id, obj.m_game_vertex_id
			sim:release(obj)

			local se_npc
			if nepis[a].script then
				se_npc = loadstring("return "..nepis[a].script.."()")()
			else
				se_npc = sim:create(sim:spawn_id(nepis[a].story_id))
			end
			if se_npc then
				sim:teleport_object("", pos, lv, gv, se_npc.id)
			end
			return
		end
	end
end
function nepis_umer()
	local obj, name, nu
	for a=1,#nepis,1 do
		obj = alife():story_object(nepis[a].story_id)
		if  obj and not obj:alive() then
			name=obj:name()
			nu="nu"..tostring(nepis[a].story_id)
			
			if nepis[a]._umer then
				db.actor:give_info_portion(name.."_umer")
			end
			
			if ( not nepis[a].trup ) and ( not has_alife_info(nu) ) then
				db.actor:give_info_portion(nu)
				archievements.send_umer_info(obj)
			end
		end
	end
end

-- проверка для уборщика по списку воскрешаемых ЖС
function can_be_resurrected(obj)
	for a=1,#nepis do
		if obj.m_story_id == nepis[a].story_id then
--			get_console():execute("load ~#I#:"..string.format("Воскресить ЖС: "..obj:name()))
			return true
		end
	end
	return false
end

-- проверка что все квестовики живы
function all_questmen_alive()
	local obj
	for a=1,#nepis do
		obj = alife():story_object(nepis[a].story_id)
		if obj and not obj:alive() then
--			get_console():execute("load ~#I#:"..string.format("Мёртвый квестовик: "..nepis[a].story_id))
			return false
		end
	end
	return true
end


function af_zone_off(af)
 local anom=amk_anoms.get_nearest_anomaly(db.actor)
 local sid=alife():object(anom)
  level.add_pp_effector("teleport.ppe", 1524, false)
  amk.remove_item(af)
  alife():release(sid,true)
end
function inv_item_cond(item,val)
local obj=db.actor:object(item)
	if obj~=nil then
	  obj:set_condition(val)
	end
end

local points = {
	kordon = {
		lname = "l01_escape",
		p = {
			{position={x=-244.69,y=-14.27,z=-16.33},gv=67,lv=12579}, 
			{position={x=107.54,y=-7.14,z=1.09},gv=119,lv=408816}, 
			{position={x=71.48,y=1.92,z=158.79},gv=96,lv=362726}, 
			{position={x=33.69,y=5.02,z=407.89},gv=246,lv=565356}, 
			{position={x=220.57,y=7.62,z=100.55},gv=152,lv=511605} 
		}
	},
	yantar = {
		lname = "l08_yantar",
		p = {
			{position={x=165.06,y=-8.19,z=-103.95},gv=1442,lv=131181}, 
			{position={x=92.58,y=0.02,z=-39.23},gv=1515,lv=87813},
			{position={x=34.48,y=0.04,z=18.19},gv=1445,lv=56341},
			{position={x=24.61,y=0.02,z=-62.60},gv=1505,lv=51069}, 
			{position={x=-60.17,y=-10.21,z=-202.66},gv=1447,lv=17529}
		}
	},
	pripat = {
		lname = "l11_pripyat",
		p = {
			{position={x=49.78,y=-3.6,z=120.99},gv=2166,lv=161768}, 
			{position={x=191.20,y=-2.0,z=219.52},gv=2219,lv=260280}, 
			{position={x=164.51,y=-3.89,z=80.83},gv=2145,lv=250751}, 
			{position={x=-97.65,y=-2.4,z=71.81},gv=2140,lv=18233}, 
			{position={x=116.64,y=-0.61,z=216.98},gv=2163,lv=226288}
		}
	},
	military = {
		lname = "l07_military",
		p = {
			{position={x=81.65,y=-12.57,z=60.67},gv=1558,lv=379105}, 
			{position={x=-35.96,y=-21.29,z=375.80},gv=1821,lv=272475}, 
			{position={x=-264.86,y=-22.6,z=275.85},gv=1797,lv=72698},
			{position={x=-340.59,y=-13.62,z=388.84},gv=1847,lv=12469}
		}
	},
	stancia = {
		lname = "l12_stancia",
		p = {
			{position={x=374.82,y=0,z=33.345},gv=2384,lv=161393}
		}
	}
}

local out_points = {
	kordon_sak	= { position = { x = -210,   y = -20.53, z = -145.78 }, gv = 61,   lv = 43273  },
	kordon		= { position = { x = 301.11, y = 13.31,  z = 276.43  }, gv = 246,  lv = 565356 },
	yantar		= { position = { x = -60.78, y = -13.02, z = -253.92 }, gv = 1454, lv = 17204  },
	pripat		= { position = { x = 52.17,  y = -3.5,   z = 120.94  }, gv = 2166, lv = 164012 },
	military	= { position = { x = -94.71, y = -20.55, z = 229.54  }, gv = 1734, lv=220072   },
	sarcofag	= { position = { x = 23.58,  y = 56,     z = 25.68   }, gv = 2417, lv=5160     }
}
function get_kordon_military() get_teleport("kordon","military",1,9121) end
function get_kordon_yantar() get_teleport("kordon","yantar",1,9121) end
function get_kordon_pripyat() get_teleport("kordon","pripat",1,9121) end
function get_pripyat_military() get_teleport("pripat","military",1,9122) end
function get_pripyat_yantar() get_teleport("pripat","yantar",1,9122) end
function get_pripyat_kordon() get_teleport("pripat","kordon",1,9122) end
function get_military_kordon() get_teleport("military","kordon",1,9123) end
function get_military_pripyat() get_teleport("military","pripat",1,9123) end
function get_military_yantar() get_teleport("military","yantar",1,9123) end
function get_yantar_military() get_teleport("yantar","military",1,9124) end
function get_yantar_kordon() get_teleport("yantar","kordon",1,9124) end
function get_yantar_pripyat() get_teleport("yantar","pripat",1,9124) end
function get_kordon_militaryr() get_teleport("kordon","military",0,9121) end
function get_kordon_yantarr() get_teleport("kordon","yantar",0,9121) end
function get_kordon_pripyatr() get_teleport("kordon","pripat",0,9121) end
function get_pripyat_militaryr() get_teleport("pripat","military",0,9122) end
function get_pripyat_yantarr() get_teleport("pripat","yantar",0,9122) end
function get_pripyat_kordonr() get_teleport("pripat","kordon",0,9122) end
function get_military_kordonr() get_teleport("military","kordon",0,9123) end
function get_military_pripyatr() get_teleport("military","pripat",0,9123) end
function get_military_yantarr() get_teleport("military","yantar",0,9123) end
function get_yantar_militaryr() get_teleport("yantar","military",0,9124) end
function get_yantar_kordonr() get_teleport("yantar","kordon",0,9124) end
function get_yantar_pripyatr() get_teleport("yantar","pripat",0,9124) end
function get_sarcofag_stancia() get_teleport("sarcofag","stancia",1,9125) end

function get_teleport(pos_out,pos_in,made,sidlc)
	local a = out_points[ pos_out ]

	local tmp = points[ pos_in ]
	local name_level = tmp.lname
	local b = ( made == 0 and  table.random( tmp.p ) ) or tmp.p[ 1 ]

	local obj1 = alife():create("level_changer",vector():set(a.position.x,a.position.y,a.position.z), a.lv, a.gv)
	local obj_tp = alife():create("zone_teleport",vector():set(a.position.x,a.position.y,a.position.z), a.lv, a.gv)
	local obj_tport = obj_tp.id
	amk.save_variable("sak_teleport", obj_tport)  
	if obj1 then
		local obj2 = alife():story_object(9120)
		local t = netpk:get(obj2, netpk.fState)
		t.story_id = sidlc
		t.dest_level_name = name_level
		t.dest_position = vector():set(b.position.x,b.position.y,b.position.z)
		t.dest_game_vertex_id = b.gv
		t.dest_level_vertex_id = b.lv
		t.silent_mode = 1
		netpk:set(obj1, t)
	end

	info_teleport()
end

function out_teleport()
local sid={9121,9122,9123,9124,9125}
local lev={"l01_escape","l11_pripyat","l07_military","l08_yantar","l12u_sarcofag"}
	for a=1,#sid,1 do
	local sidlc=sid[a]
	local lname=lev[a]	
	local obj=alife():story_object(sidlc)
		if obj and level.name()~=lname then
		local objt = amk.load_variable("sak_teleport", 0)
		alife():release(obj)
			if objt ~= 0 then
                alife():release(alife():object(objt), true)
            end
		amk.del_variable("sak_teleport")
		end
	end
--	show_time()
--	arc_main.actor_update() -- !!!
end

function switch_mil_matugalnik()
	local obj=sim:object("mil_physic_destroyable_object_0046")
	if obj then
		local params = {}
		params.custom_data="[logic]\ncfg = scripts\\mil\\matugalnik.ltx"
		netpk:modify(obj, params, netpk.fState)
	end
end
function add_3repair_item_outfit()
	inventory.give_items("repair_item_outfit",3)
end
function add_3repair_item_weapon()
	inventory.give_items("repair_item_weapon",3)
end
function add_repair_item_outfit()
	inventory.give_items("repair_item_outfit",1)
end
function add_repair_item_weapon()
	inventory.give_items("repair_item_weapon",1)
end
function add_medkit(first_speaker, second_speaker)
     dialogs.relocate_item_section(second_speaker, "medkit", "in")
     dialogs.relocate_item_section(second_speaker, "snotvornoe_tele", "in")
end 
function set_community(actor, npc)
	relation_registry.set_community_goodwill("bandit", 0, 500)
	-- поссорим актёра с конвоем Макса Любера
	local sim = alife()
	local obj = sim:object("val_escort_guard2")
	if obj and obj:alive() then
		relation_registry.set_goodwill(obj.id, db.actor:id(), -1000)
	end
	obj = sim:object("val_escort_guard1")
	if obj and obj:alive() then
		relation_registry.set_goodwill(obj.id, db.actor:id(), -1000)
	end
	-- Помирим Макса Любера и Пулю с Монголом
	obj = sim:object("val_escort_bandit_halfdead")
	if obj and obj:alive() then
		local npc1 = sim:object("val_escort_nap1")
		local npc2 = sim:object("val_escort_captive")
		if npc1 and npc1:alive() and npc2 and npc2:alive() then
			relation_registry.set_goodwill(obj.id, npc1.id, 500)
			relation_registry.set_goodwill(npc1.id, obj.id, 500)
			relation_registry.set_goodwill(obj.id, npc2.id, 500)
			relation_registry.set_goodwill(npc2.id, obj.id, 500)
		end
	end
end
function bandits_enemy(actor, npc)
	if xr_conditions.killed_by_actor(actor, npc) then
		amk.send_tip("%c[255,255,128,128]Ах ты сука! Братва, мочи козла!!!", nil, 1, 20)
	end
	relation_registry.set_community_goodwill("bandit", 0, -1500)
end
function drink_vodka()
	db.actor:eat(db.actor:object("vodka"))
end
function take_trasure(npc, npc1)
	treasure_manager.get_treasure_manager():dialog(npc)
end
function have_trasure(first_speaker, second_speaker)
	local tres
	if game_options.AmkTrs == 2 then 
	  tres = 80
	else 
      tres = 50
	end
	local ran=math_random(100)
	if ran > tres then db.actor:give_info_portion("have_sak_treasure")
	else db.actor:give_info_portion("havent_sak_treasure")
	end
end
function zombie_checkup()
	if db.actor ~= nil then
		if math_random() > 0.7 	and not inventory.on_belt("af_serpantin") then
		local a=math_random()
		local h = hit()
		h.draftsman = db.actor
		h.direction = vector():set(0,0,0)
		h:bone("bip01_spine") -- чтобv учитvвалась броня
		h.type = hit.telepatic
		h.power = 0.3+a/2
		h.impulse = 1.0
		db.actor:hit(h)
		h.type = hit.strike
		db.actor:hit(h)
		h.type = hit.radiation
		db.actor:hit(h)
		level.add_pp_effector("alcohol.ppe", 100, false)
		local rnd=math_random(1,6)
		local snd_obj
			if rnd==1 then
			snd_obj = 	xr_sound.get_safe_sound_object([[characters_voice\human_01\stalker\fight\hit\hit_1]])
			elseif rnd==2 then
			snd_obj = 	xr_sound.get_safe_sound_object([[characters_voice\human_01\stalker\fight\hit\hit_2]])
			elseif rnd==3 then
			snd_obj = 	xr_sound.get_safe_sound_object([[characters_voice\human_01\stalker\fight\hit\hit_3]])
			elseif rnd==4 then
			snd_obj = 	xr_sound.get_safe_sound_object([[characters_voice\human_01\stalker\fight\hit\hit_6]])
			elseif rnd==5 then
			snd_obj = 	xr_sound.get_safe_sound_object([[characters_voice\human_01\stalker\fight\hit\hit_7]])
			elseif rnd==6 then
			snd_obj = 	xr_sound.get_safe_sound_object([[characters_voice\human_01\stalker\fight\hit\hit_8]])
			end
			snd_obj:play_no_feedback(db.actor, sound_object.s2d, 0, vector(), 1.0)
		end
		archievements.acv_count_event("acv_fzom", 100, "Друг зомби")
	end
end
function add_spot_of_docent(a)
--[[
	local old_spot=amk.load_variable("spot_of_nps", 0)
	if old_spot~=0 then
		local obj_old = alife():story_object(old_spot)
		if obj_old then
			amk.remove_spot_from_map(obj_old.id,'blue_location')
		end
	end
	local obj = alife():story_object(a)
	if obj and IAmAStalker[obj:clsid()] then
		amk.add_spot_on_map(obj.id,'blue_location',obj:name().."_sak")
		old_spot=a
		amk.save_variable("spot_of_nps", old_spot)
	end
]]
	local obj = alife():story_object(a)
	if obj and IAmAStalker[obj:clsid()]
		and level.map_has_object_spot(obj.id, 'blue_location')==0
	then
		level.map_add_object_spot_ser(obj.id, 'blue_location', obj:name()..'_sak')
	end
end

function check_actor_community(lname, sname)
	if lname=="l04_darkvalley" then
		local obj=alife():story_object(425)
		if obj and IAmAStalker[obj:clsid()] and obj:alive() then
			if has_alife_info("val_bandit_talk") then
				relation_registry.set_community_goodwill("bandit", 0, 500)
			end
		elseif relation_registry.community_goodwill("bandit", 0) > 0 then
			relation_registry.set_community_goodwill("bandit", 0, -2000)
		end
	elseif sname == "l04_darkvalley"
		and relation_registry.community_goodwill("bandit", 0) > 0
	then
		relation_registry.set_community_goodwill("bandit", 0, -2000)
	end

	if has_alife_info("snp_almaz3")
		and ( not has_alife_info("snp_almaz_done") )
		and lname ~= "av_peshera"
		and db.actor:character_community() == "monolith"
	then
		db.actor:set_character_community("actor", 0, 0)
	end
end

function check_radio()
	local info = {"bar_random", "bar_smile", "bar_rock", "bar_rockn", "bar_modern", "bar_retro"}
	local res = false
	for i, v in ipairs(info) do
		if has_alife_info(v) then
			res = true
			break
		end
	end
	if not res then
		db.actor:give_info_portion("bar_random")
	end
end

function add_tail()
	local lname = level.name()
	local actor = db.actor

	if lname=="l05_bar" then
		check_radio()
		if has_alife_info("kot_need_next_done")
			and not has_alife_info("bkot_spawn")
		then
			local se_obj = alife():object("kot")
			if se_obj then
				alife():release(se_obj, true)
				db.actor:give_info_portion("bkot_spawn")
			end
		end

	elseif lname=="zaton" then
		check_radio()

	elseif lname=="l01_escape" then
		actor:give_info_portion("sidor_music")
		if actor:has_info("prizrak_finalzver_start")
			and not actor:has_info("info_spawn_zver")
		then
			actor:give_info_portion("info_spawn_zver")
		end

	elseif lname=="l07_military" then
		if actor:has_info("francuz_start") then
			actor:give_info_portion("francuz_spawn")
		end

	elseif lname=="l10u_bunker" then
		if actor:has_info("ucen_talk_need")
			and not actor:has_info("ucen_talk_spawn")
		then
			actor:give_info_portion("ucen_talk_spawn")
		end

	elseif lname=="l10_radar" and not has_alife_info("bar_deactivate_radar_done") then
		xr_s.subscribe("update", amk_mod.check_radar_off)

	elseif lname == "marsh" then
		xr_s.subscribe("update", marsh_radiation.update, { timeout = 500 } )
		if actor:has_info("brat_luis_start") then
			actor:give_info_portion("brat_luis_spawn")
		end

	elseif lname=="l03u_agr_underground" then
		if actor:has_info("yakut_false_start")
			and not actor:has_info("yakut_false_have")
		then
			actor:give_info_portion("yakut_false_have")
		end

	elseif lname=="l03_agroprom" then
		if actor:has_info("yakut_false_have")
			and not actor:has_info("yakut_false_done")
		then
			actor:give_info_portion("yakut_false_done")
		end
		if actor:has_info("kot_agro_mono_start") 
			and not has_alife_info("kot_agro_mono_spawn")
		then
			actor:give_info_portion("kot_agro_mono_spawn")
		end

	elseif lname=="l06_rostok" then
		if actor:has_info("zahar_naemnik_start")
			and not actor:has_info("zahar_naemnik_begin")
		then
			actor:give_info_portion("zahar_naemnik_begin")
		end

	elseif lname=="l11_pripyat" then
		if has_alife_info("kot_find_rabi_scromnyi")
			and not has_alife_info("kot_find_rabi_spawn_rabi")
		then
			db.actor:give_info_portion("kot_find_rabi_spawn_rabi")
		end

	elseif lname == "red_forest" then
		if not has_alife_info("actor_in_forest") then
			db.actor:give_info_portion("actor_in_forest")
		end

	elseif lname == "av_peshera" then
		if not has_alife_info("spawn_teleport_exit") then 
			alife():create("m_teleport_exit",vector():set(102.761,31.20,410.701),168848,2985)
			db.actor:give_info_portion("spawn_teleport_exit")
		end

	elseif lname == "hospital" then
		if (not has_alife_info("spawn_teleport_hospital"))
			and has_alife_info("pri_helicopters_start")
		then 
			alife():create("m_teleport_hospital",vector():set(-74.66,23.69,562.013),7350,3075)
			db.actor:give_info_portion("spawn_teleport_hospital")
		end	
	end
	
	if lname~="l03_agroprom"
		and actor:has_info("ratcatcher_order_done")
		and not actor:has_info("ratcatcher_out")
	then
		actor:give_info_portion("ratcatcher_out")
	end

	if lname~="l05_bar"
		and actor:has_info("info_way_false")
		and not actor:has_info("informer_out")
	then
		actor:give_info_portion("informer_out")
	end
end

function off_testobj()
	-- переделано на поршни - при выбросе снимаем все поршни, при спавне артов на локе выдаем
	db.actor:disable_info_portion("testsak_l01_escape")
	db.actor:disable_info_portion("testsak_l02_garbage")
	db.actor:disable_info_portion("testsak_l03_agroprom")
	db.actor:disable_info_portion("testsak_l04_darkvalley")
	db.actor:disable_info_portion("testsak_l05_bar")
	db.actor:disable_info_portion("testsak_l06_rostok")
	db.actor:disable_info_portion("testsak_l07_military")
	db.actor:disable_info_portion("testsak_l08_yantar")
	db.actor:disable_info_portion("testsak_l10_radar")
	db.actor:disable_info_portion("testsak_l11_pripyat")
	db.actor:disable_info_portion("testsak_l12_stancia")
	db.actor:disable_info_portion("testsak_atp_for_test22")
	db.actor:disable_info_portion("testsak_puzir")
	db.actor:disable_info_portion("testsak_aver")
	db.actor:disable_info_portion("testsak_marsh")
	db.actor:disable_info_portion("testsak_limansk")
	db.actor:disable_info_portion("testsak_dead_city")
	db.actor:disable_info_portion("testsak_generators")
	db.actor:disable_info_portion("testsak_hospital")
	db.actor:disable_info_portion("testsak_lost_village")
	db.actor:disable_info_portion("testsak_red_forest")
	db.actor:disable_info_portion("testsak_zaton")
	db.actor:disable_info_portion("testsak_jupiter")
	db.actor:disable_info_portion("testsak_pripyat")

--[[ старый код
	local obj
	for a=1,65534,1 do
	obj=alife():object(a)
		if obj and string_find(obj:name(),"testsak_") then
		alife():release(obj,true)
		end
	end
]]
end
function add_borov_treasure()
	treasure_manager.get_treasure_manager():give_treasure("mil_borov_secret")
end
function add_krysyk_treasure()
	treasure_manager.get_treasure_manager():give_treasure("agr_krysyk_secret")
end
function add_krysyk_pda()
	treasure_manager.get_treasure_manager():give_treasure("val_krysyk_secret")
end
-- Продолжение Крысюк - Жила:
function krysyk_enemy(first_speaker, second_speaker)
	local act = db.actor
	local npc = first_speaker:id() == act:id() and second_speaker or first_speaker
	start_small_timer(400, function ()
		npc:set_relation(game_object.enemy, act)
	end)
	act:give_info_portion("bandit_krisyk_finish")
	act:give_info_portion("bandit_krisyk_enemy")
end
function krysyk_umer()
	if has_alife_info("bandit_krisyk_finish") then 
		db.actor:give_info_portion("bandit_krisyk_finish2")
	else
		db.actor:give_info_portion("bandit_krisyk_umer2")
	end
end
--
function dbglog(fmt,...)
  local msg = string_format(fmt, ...)
  local msg_no_ws = string_gsub(msg, "%s", "___")
  get_console():execute("dbg:" .. msg_no_ws)
end
-----------------------------------------------------------------------------------------------------------